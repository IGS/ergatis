<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
    <meta http-equiv="Content-Language" content="en-us">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/documentation.css">
    <script type='text/javascript' src='../javascript/pipeline_structure_detail.js'></script>
    <title>workflow documentation: pipeline structure detail</title>
</head>

<body>

<div id="noteviewer">
    <span onClick="toggleNotes();">show/hide modification notes</span>
</div>

<h1>Workflow instance (pipeline) and subflow file structure detail</h1>
<p>
    date created: 2005-05-13<br>
    last modified: 2006-02-17
</p>
<p>
    The creation of even a simple workflow involves the interaction of several scripts and
    libraries, along with the generation of a host of xml and ini files.  This document 
    describes the flow of this process, including the scripts involved in the creation and
    running of a workflow pipeline as well as the structure of the files themselves.  I'm
    going to go through this as if the pipeline was being built from scratch in a stepwise
    manner using Sam's web-based interface.
</p>
<p>
    The paths to all files in this document are relative the Workflow directory under what 
    we refer to as the repository root.  Each project has its own repository root which 
    usually is something like:
</p>
<p>
    REPOSITORY_ROOT = /usr/local/annotation/AA1
</p>
<p>
    So, in this case, all paths would be relative to:
</p>
<p>
    /usr/local/annotation/AA1/Workflow
</p>

<h2>new pipeline</h2>
<p>
    The new_pipeline.cgi script is used to create a new pipeline and is invoked by clicking
    the [new] button on the interface.  It creates a skeleton 
    command set that serves as the root of our workflow.  Specifically, it generates the 
    following two files:
</p>
<div>
    <a href="javascript: hideShow('skeletonxml')"><img class='expander' id="iskeletonxml" src="../images/plus.png" alt='expand'></a>
    <span class="filename">pipeline/856/pipeline.xml</span>
    <div class="filecontents code" id="skeletonxml">
    &lt;commandSetRoot xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="commandSet.xsd"&gt;
        &lt;commandSet type="serial"&gt;
            &lt;configMapId&gt;start&lt;/configMapId&gt;
        &lt;/commandSet&gt;
    &lt;/commandSetRoot&gt;
    </div>
</div>
<div>
    <a href="javascript: hideShow('skeletonini')"><img class='expander' id="iskeletonini" src="../images/plus.png" alt='expand'></a>
    <span class="filename">pipeline/856/pipeline.xml.ini</span>
    <div class="filecontents code" id="skeletonini">
    [start]
    </div>
</div>
<p>
    This skeleton root contains a single, empty commandSet that has a configMapId to start.
    The number in the file names above is the pipeline id and is generated using the
    Workflow::IdGenerator perl module.  So long as all installs point to the same ID
    repository, these ids will be globally unique (with respect to a filesystem) and sequential.
</p>
<h2>adding a component</h2>
<p>
    We are going to add a wu-blastp component to this pipeline.  We start by clicking the
    [Edit mode] link, which does nothing on the filesystem but displays [-] and [+] symbols
    within our skeleton root.  Clicking the [+], we are presented with the list (generated
    by the add.cgi script) of recent pipelines run and components available for 
    configuration.
</p>
<p>
    From this list we can click the wu-blastp component, which calls config_component.cgi.
    This script reads the default configuration file for this component and creates a form
    out of it so that users may change any of the values within it.  After these changes are
    made, such as the definition of the input set, this same script writes this customized
    copy of the conf file to the filesystem.  My configuration is below:
</p>
<div>
    <a href="javascript: hideShow('blastpconfini')"><img class='expander' id="iblastpconfini" src="../images/plus.png" alt='expand'></a>
    <span class="filename">wu-blastp/856_default/component.conf.bld.ini</span>
    <div class="filecontents code" id="blastpconfini">
    #configuration file for the wu-blastp workflow
    [parameters wu-blastp]
    $;MATRIX$;=BLOSUM62
    $;EXPECT$;=1e-5
    $;FILTER$;=none
    $;DATABASE_MATCHES$;=150
    $;DESCRIPTIONS$;=150
    $;GSPMAX$;=5
    $;OTHER_OPTS$;=

    [input wu-blastp]
    $;INPUT_FILE_LIST$;=/usr/local/annotation/AA1/FASTA_repository/test.list
    $;INPUT_FILE$;=
    $;INPUT_DIRECTORY$;=
    $;INPUT_EXTENSION$;=fsa
    $;DATABASE_PATH$;=/usr/local/db/panda/AllGroup/AllGroup.niaa

    [output wu-blastp]
    $;OUTPUT_TOKEN$;=default
    $;OUTPUT_DIRECTORY$;=$;REPOSITORY_ROOT$;/output_repository/$;NAME$;/$;PIPELINEID$;_$;OUTPUT_TOKEN$;
    $;BSML_OUTPUT_LIST$;=$;OUTPUT_DIRECTORY$;/$;NAME$;.bsml.list
    $;BTAB_OUTPUT_LIST$;=$;OUTPUT_DIRECTORY$;/$;NAME$;.btab.list
    $;RAW_OUTPUT_LIST$;=$;OUTPUT_DIRECTORY$;/$;NAME$;.raw.list
    $;COMPRESS_RAW_OUTPUT$;=0

    [workflowdocs wu-blastp]
    $;VERSION$;=2.0
    $;REVISION$;=$Revision$
    $;TAG$;=$Name$
    $;ALGORITHM$;=wu-blast
    $;NAME$;=wu-blastp
    $;MASTER_TEMPLATE_INI$;=$;WORKFLOWDOCS_DIR$;/wu-blastp-master.ini
    $;MASTER_TEMPLATE_XML$;=$;WORKFLOWDOCS_DIR$;/wu-blastp-master_template.xml
    $;TEMPLATE_INI$;=$;WORKFLOWDOCS_DIR$;/wu-blastp.ini
    $;TEMPLATE_XML$;=$;WORKFLOWDOCS_DIR$;/wu-blastp_template.xml
    $;WORKFLOW_REPOSITORY$;=$;REPOSITORY_ROOT$;/Workflow/$;NAME$;/$;PIPELINEID$;_$;OUTPUT_TOKEN$;
    $;GROUP_COUNT$;=150
    $;COMPONENT_CONFIG$;=
    $;NODISTRIB$;=0

    [include wu-blastp]
    $;SHARED_CONFIG$;=/usr/local/annotation/AA1/workflow_config_files/sharedconf.ini
    </div>
</div>
<p>
    Notice that the configuration file has many variables formatted like $;NAME$;.  These
    will be used within other configuration files later and the variables will be resolved
    to their proper paths.
</p>
<p>
    After writing this configuration file I must reload the component list to make my newly
    customized configuration appear near the top.  Beside it there is an [add] link, which
    calls add_component.cgi.  After we click this, quite a lot happens.  First, our skeleton
    pipeline files are updated with the sections for this component.  I'll use a bit of
    line-wrapping on the commands to make this easier to see.
</p>
<div>
    <a href="javascript: hideShow('skeletonxml_withblastp')"><img class='expander' id="iskeletonxml_withblastp" src="../images/plus.png" alt='expand'></a>
    <span class="filename">pipeline/856/pipeline.xml</span>
    <div class="filecontents code" id="skeletonxml_withblastp">
    &lt;commandSetRoot xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="commandSet.xsd"&gt;
      &lt;commandSet type="serial"&gt;
        &lt;configMapId&gt;start&lt;/configMapId&gt;
        &lt;commandSet type="serial"&gt;
          &lt;configMapId&gt;component_wu-blastp.default&lt;/configMapId&gt;
          &lt;command&gt;
            &lt;type&gt;RunUnixCommand&lt;/type&gt;
            &lt;configMapId&gt;generate_component_wu-blastp.default&lt;/configMapId&gt;
            &lt;name&gt;Generate component wu-blastp.default&lt;/name&gt;
            &lt;param&gt;
              &lt;key&gt;command&lt;/key&gt;
              &lt;value&gt;/usr/local/devel/ANNOTATION/ard/testing_manual/bin/run_pipeline&lt;/value&gt;
            &lt;/param&gt;
            &lt;arg&gt;-c /usr/local/annotation/AA1/Workflow/wu-blastp/856_default/component.conf.bld.ini --skiprun --pipelineid=856&lt;/arg&gt;
          &lt;/command&gt;
          &lt;commandSet type="serial" version="2.2"&gt;
            &lt;name&gt;wu-blastp.default&lt;/name&gt;
            &lt;maxParallelCmds&gt;0&lt;/maxParallelCmds&gt;
            &lt;configMapId&gt;run_component_wu-blastp.default&lt;/configMapId&gt;
            &lt;fileName&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/pipeline.xml&lt;/fileName&gt;
            &lt;state&gt;incomplete&lt;/state&gt;
          &lt;/commandSet&gt;
        &lt;/commandSet&gt;
      &lt;/commandSet&gt;
    &lt;/commandSetRoot&gt;
    </div>
</div>
<div>
    <a href="javascript: hideShow('skeletonini_withblastp')"><img class='expander' id="iskeletonini_withblastp" src="../images/plus.png" alt='expand'></a>
    <span class="filename">pipeline/856/pipeline.xml.ini</span>
    <div class="filecontents code" id="skeletonini_withblastp">
    [start]

    [component_wu-blastp.default]

    [generate_component_wu-blastp.default]

    [run_component_wu-blastp.default]

    </div>
</div>
<p>
    Those serve as a template xml and template ini to create the instance file that will come
    later.
</p>
<div class="changenote">
    All commands and commandSets must have a configMapId that maps to something in the ini configuration 
    file.  There seems to be a lot of instances where some configmapId is made up, such as the run_subflow one
    above, that maps to an empty entry in the ini file.  Why maintain this complexity?  When we know that
    a commandSet isn't going to rely on anything in the config file, we should be able to use a standard
    configmapId such as "empty".  When the Workflow engine sees this, it would know to skip the search
    for the mapping within the config file.
</div>

<h2>running the pipeline - overview</h2>
<p>
    We could now run this workflow by clicking the [Run] link.  This link follows the URL below,
    and we're going to map what happens when we do this.
</p>
<div class="code">
    http://localhost:8080/tigr-scripts/ergatis/run_wf.cgi?
        xmltemplate=/usr/local/annotation/AA1/Workflow/pipeline/856/pipeline.xml&
        inifile=/usr/local/annotation/AA1/Workflow/pipeline/856/pipeline.xml.ini&
        instancexml=/usr/local/annotation/AA1/Workflow/pipeline/856/pipeline.xml.instance&
        pipelineid=856
</div>
<p>
    This uses the pipeline.xml and pipeline.xml.ini files we created before as templates
    to create our instance file.  This instance file is nearly identical to the pipeline.xml
    file, but it didn't used to be, and I'm thinking we can get rid of the instance files
    in the near future.
</p>
<div class="changenote">
    See the note above.  Why do we still need both the xml and .instance files?  I talked to 
    Sree and he said the main thing is that we need to generate IDs, and Workflow does this
    based off the template.  Instead, I invoked the CreateWorkflow command below using the
    pipeline.xml file as both the -i and -t options and it worked fine.  Do we care if
    we lose the 'template' here?
</div>
<p>
    This actually performs two steps, it first creates the pipeline.xml.instance file and then
    uses a separate command to run it.  They are:
</p>
<div class="code">
    CreateWorkflow 
        -debug 
        -i /usr/local/annotation/AA1/Workflow/pipeline/856/pipeline.xml.instance
        -t /usr/local/annotation/AA1/Workflow/pipeline/856/pipeline.xml
        -c /usr/local/annotation/AA1/Workflow/pipeline/856/pipeline.xml.ini
        --delayedbuild=true 
        --autobuild=false 
        > /usr/local/annotation/AA1/Workflow/pipeline/856/pipeline.xml.instance.create.out 2>&1
        
    RunWorkflow 
        -i /usr/local/annotation/AA1/Workflow/pipeline/856/pipeline.xml.instance
        --logconf=/usr/local/devel/ANNOTATION/ard/workflow.log4j.properties 
        > /usr/local/annotation/AA1/Workflow/pipeline/856/pipeline.xml.instance.run.out 2>&1
</div>
<p>
    The first step creates the instance file, which looks like this:
</p>
<div>
    <a href="javascript: hideShow('pipeline981.xml.instance')"><img class='expander' id="ipipeline981.xml.instance" src="../images/plus.png" alt='expand'></a>
    <span class="filename">pipeline/856/pipeline.xml.instance</span>
    <div class="filecontents code" id="pipeline981.xml.instance">
    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;commandSetRoot type="instance"&gt;
        &lt;commandSet type="serial" version="2.2"&gt;
            &lt;name&gt;&lt;/name&gt;
            &lt;id&gt;155191309&lt;/id&gt;
            &lt;maxParallelCmds&gt;0&lt;/maxParallelCmds&gt;
            &lt;configMapId&gt;start&lt;/configMapId&gt;
            &lt;state&gt;incomplete&lt;/state&gt;
            &lt;commandSet type="serial" version="2.2"&gt;
                &lt;name&gt;&lt;/name&gt;
                &lt;id&gt;155191310&lt;/id&gt;
                &lt;maxParallelCmds&gt;0&lt;/maxParallelCmds&gt;
                &lt;configMapId&gt;component_wu-blastp.default&lt;/configMapId&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
                &lt;command&gt;
                    &lt;name&gt;Generate component wu-blastp.default&lt;/name&gt;
                    &lt;id&gt;155191311&lt;/id&gt;
                    &lt;configMapId&gt;generate_component_wu-blastp.default&lt;/configMapId&gt;
                    &lt;state&gt;incomplete&lt;/state&gt;
                    &lt;type&gt;RunUnixCommand&lt;/type&gt;
                    &lt;retryCount&gt;0&lt;/retryCount&gt;
                    &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
                    &lt;timeOut&gt;0&lt;/timeOut&gt;
                    &lt;param&gt;
                        &lt;key&gt;command&lt;/key&gt;
                        &lt;value&gt;/usr/local/devel/ANNOTATION/ard/testing_manual/bin/run_pipeline&lt;/value&gt;
                    &lt;/param&gt;
                    &lt;arg&gt;-c /usr/local/annotation/AA1/Workflow/wu-blastp/856_default/component.conf.bld.ini --skiprun --pipelineid=856&lt;/arg&gt;
                &lt;/command&gt;
                &lt;commandSet type="serial" version="2.2"&gt;
                    &lt;name&gt;wu-blastp.default&lt;/name&gt;
                    &lt;id&gt;155191312&lt;/id&gt;
                    &lt;maxParallelCmds&gt;0&lt;/maxParallelCmds&gt;
                    &lt;configMapId&gt;run_component_wu-blastp.default&lt;/configMapId&gt;
                    &lt;fileName&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/pipeline.xml&lt;/fileName&gt;
                    &lt;state&gt;incomplete&lt;/state&gt;
                &lt;/commandSet&gt;
            &lt;/commandSet&gt;
        &lt;/commandSet&gt;
    &lt;/commandSetRoot&gt;
    </div>
</div>
<p>
    This instance file has two sections/steps for each component.  Since we only added a
    wu-blastp component, we have only one instance of this:
</p>
    <ol>
        <li>
            calls run_pipeline, using the --skiprun option, on the manually configured wu-blastp
            component we created.  this creates the pipeline.xml for this component.
        </li>
        <li>
            the instance file created in the previous step is now executed here as a file-based
            subflow.
        </li>
    </ol>
<p>
    We'll discuss each of these steps below.
</p>
<h2>running the pipeline - 1. run_pipeline</h2>
<p>
    The actual command run in this step of the instance file is:
</p>
<p class="code">
    run_pipeline 
        -c /usr/local/annotation/AA1/Workflow/wu-blastp/856_default/component.conf.bld.ini 
        --skiprun 
        --pipelineid=856
</p>
<p>
    This creates a few files.  First, the component.conf.bld.ini file the user filled out is
    read and all variables are replaced within it.  The values in sharedconf.ini are also imported.
    This creates:
</p>
<div>
    <a href="javascript: hideShow('wu-blastp.pipeline.config')"><img class='expander' id="iwu-blastp.pipeline.config" src="../images/plus.png" alt='expand'></a>
    <span class="filename">wu-blastp/856_default/pipeline.config</span>
    <div class="filecontents code" id="wu-blastp.pipeline.config">
    #configuration file for the wu-blastp workflow
    [parameters wu-blastp]
    $;MATRIX$;=BLOSUM62
    $;EXPECT$;=1e-5
    $;FILTER$;=none
    $;DATABASE_MATCHES$;=150
    $;DESCRIPTIONS$;=150
    $;GSPMAX$;=5
    $;OTHER_OPTS$;=

    [input wu-blastp]
    $;INPUT_FILE_LIST$;=/usr/local/annotation/AA1/FASTA_repository/test.list
    $;INPUT_FILE$;=
    $;INPUT_DIRECTORY$;=
    ;; the following is only used when iterating over an INPUT_DIRECTORY
    $;INPUT_EXTENSION$;=fsa
    $;DATABASE_PATH$;=/usr/local/db/panda/AllGroup/AllGroup.niaa

    [output wu-blastp]
    $;OUTPUT_TOKEN$;=default
    $;OUTPUT_DIRECTORY$;=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default
    $;BSML_OUTPUT_LIST$;=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default/wu-blastp.bsml.list
    $;BTAB_OUTPUT_LIST$;=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default/wu-blastp.btab.list
    $;RAW_OUTPUT_LIST$;=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default/wu-blastp.raw.list
    $;COMPRESS_RAW_OUTPUT$;=0

    [workflowdocs wu-blastp]
    $;VERSION$;=2.0
    $;REVISION$;=$Revision$
    $;TAG$;=$Name$
    $;ALGORITHM$;=wu-blast
    $;NAME$;=wu-blastp
    $;MASTER_TEMPLATE_INI$;=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/wu-blastp-master.ini
    $;MASTER_TEMPLATE_XML$;=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/wu-blastp-master_template.xml
    $;TEMPLATE_INI$;=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/wu-blastp.ini
    $;TEMPLATE_XML$;=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/wu-blastp_template.xml
    $;WORKFLOW_REPOSITORY$;=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default
    $;GROUP_COUNT$;=150
    ;the following keys are replaced at runtime by the invocation script
    $;COMPONENT_CONFIG$;=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/pipeline.config
    $;NODISTRIB$;=0

    [include wu-blastp]
    $;SHARED_CONFIG$;=/usr/local/annotation/AA1/workflow_config_files/sharedconf.ini

    ;shared configuration file.  These parameters will be used for all subflows.
    ;all these parameters are required.
    [init]
    ;eg. chado_test
    $;DATABASE$;=aa1
    ;eg /usr/local/annotation/CHADO_TEST
    $;REPOSITORY_ROOT$;=/usr/local/annotation/AA1
    $;TMP_DIR$;=/usr/local/scratch/aa1/wu-blastp/856_default
    ;; these must each be full paths - no variable references.
    $;ERGATIS_DIR$;=/usr/local/devel/ANNOTATION/ard/testing_manual
    $;LIB_DIR$;=/usr/local/devel/ANNOTATION/ard/testing_manual/lib
    $;BIN_DIR$;=/usr/local/devel/ANNOTATION/ard/testing_manual/bin
    $;SCHEMA_DIR$;=/usr/local/devel/ANNOTATION/ard/testing_manual/docs
    $;WORKFLOWDOCS_DIR$;=/usr/local/devel/ANNOTATION/ard/testing_manual/docs
    $;DEBUG$;=0
    ;the following keys are replaced at runtime by the invocation script
    $;WFID$;=16488
    $;PIPELINEID$;=856

    </div>
</div>
<p>
    Within the ergatis install directory, the master template configution file for this component 
    is now read and the values in the pipeline.config are used to replace any variables it contains.
    So here's an example of the wu-blastp-master.ini tempate file:
</p>
<div>
    <a href="javascript: hideShow('wu-blastp.master.ini')"><img class='expander' id="iwu-blastp.master.ini" src="../images/plus.png" alt='expand'></a>
    <span class="filename">INSTALLDIR/workflow/wu-blastp.master.ini</span>
    <div class="filecontents code" id="wu-blastp.master.ini">
    [empty]

    [create_compute_scratch]
    ;make the new scratch directory
    param.command=mkdir
    arg=-p -m 777 $;TMP_DIR$;

    [create_compute_output]
    ;make the output directory
    param.command=mkdir
    arg=-p -m 777 $;OUTPUT_DIRECTORY$;

    [create_bsml_list]
    param.command=find
    arg=$;OUTPUT_DIRECTORY$; -regex ".*.$;NAME$;.bsml"
    param.stdout=$;BSML_OUTPUT_LIST$;

    [create_raw_list]
    param.command=find
    arg=$;OUTPUT_DIRECTORY$; -regex ".*.$;NAME$;.raw"
    param.stdout=$;RAW_OUTPUT_LIST$;

    [create_btab_list]
    param.command=find
    arg=$;OUTPUT_DIRECTORY$; -regex ".*.$;NAME$;.btab"
    param.stdout=$;BTAB_OUTPUT_LIST$;

    [create_iterator_list_subflow1]
    param.command=$;BIN_DIR$;/generate_input_list
    param.filelist='$;INPUT_FILE_LIST$;'
    param.file='$;INPUT_FILE$;'
    param.directory='$;INPUT_DIRECTORY$;'
    param.extension='$;INPUT_EXTENSION$;'
    param.output=$;WORKFLOW_REPOSITORY$;/subflow1.list

    [create_groups_subflow1]
    param.command=$;BIN_DIR$;/generate_groups
    param.output_dir=$;WORKFLOW_REPOSITORY$;
    param.prefix=subflow1groups
    param.group_count=$;GROUP_COUNT$;
    param.file=$;WORKFLOW_REPOSITORY$;/subflow1.list

    [create_iterative_subflow1]
    ;create iterative subflow
    param.command=$;BIN_DIR$;/generate_subflow
    ;workflow doc information
    param.template=$;WORKFLOWDOCS_DIR$;/groups-iterator_template.xml
    param.inifile=$;WORKFLOWDOCS_DIR$;/groups-iterator.ini
    param.iteratortemplate=$;WORKFLOWDOCS_DIR$;/batch-paralleliterator_template.xml
    param.iteratorini=$;WORKFLOWDOCS_DIR$;/batch-iterator.ini
    param.iteratorlist=$;WORKFLOW_REPOSITORY$;/subflow1groups.list
    param.conf=$;COMPONENT_CONFIG$;
    param.wfname=$;NAME$;
    ;output information
    param.outputdir=$;WORKFLOW_REPOSITORY$;
    param.outputxml=$;WORKFLOW_REPOSITORY$;/groups.xml
    param.debug=$;DEBUG$;

    [subflow1]
    fileName = $;WORKFLOW_REPOSITORY$;/groups.xml
    </div>
</div>
<p>
    So, using that file as a template, and the values in pipeline.config, we get the final 
    master ini file for this component:
</p>
<div>
    <a href="javascript: hideShow('wu-blastp_pipeline.ini')"><img class='expander' id="iwu-blastp_pipeline.ini" src="../images/plus.png" alt='expand'></a>
    <span class="filename">wu-blastp/856_default/pipeline.ini</span>
    <div class="filecontents code" id="wu-blastp_pipeline.ini">
    [empty]

    [create_compute_scratch]
    ;make the new scratch directory
    param.command=mkdir
    arg=-p -m 777 /usr/local/scratch/aa1/wu-blastp/856_default

    [create_compute_output]
    ;make the output directory
    param.command=mkdir
    arg=-p -m 777 /usr/local/annotation/AA1/output_repository/wu-blastp/856_default

    [create_bsml_list]
    param.command=find
    arg=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default -regex ".*.wu-blastp.bsml"
    param.stdout=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default/wu-blastp.bsml.list

    [create_raw_list]
    param.command=find
    arg=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default -regex ".*.wu-blastp.raw"
    param.stdout=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default/wu-blastp.raw.list

    [create_btab_list]
    param.command=find
    arg=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default -regex ".*.wu-blastp.btab"
    param.stdout=/usr/local/annotation/AA1/output_repository/wu-blastp/856_default/wu-blastp.btab.list

    [create_iterator_list_subflow1]
    param.command=/usr/local/devel/ANNOTATION/ard/testing_manual/bin/generate_input_list
    param.filelist='/usr/local/annotation/AA1/FASTA_repository/test.list'
    param.file=''
    param.directory=''
    param.extension='fsa'
    param.output=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/subflow1.list

    [create_groups_subflow1]
    param.command=/usr/local/devel/ANNOTATION/ard/testing_manual/bin/generate_groups
    param.output_dir=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default
    param.prefix=subflow1groups
    param.group_count=150
    param.file=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/subflow1.list

    [create_iterative_subflow1]
    ;create iterative subflow
    param.command=/usr/local/devel/ANNOTATION/ard/testing_manual/bin/generate_subflow
    ;workflow doc information
    param.template=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/groups-iterator_template.xml
    param.inifile=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/groups-iterator.ini
    param.iteratortemplate=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/batch-paralleliterator_template.xml
    param.iteratorini=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/batch-iterator.ini
    param.iteratorlist=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/subflow1groups.list
    param.conf=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/pipeline.config
    param.wfname=wu-blastp
    param.nodistrib        = 0
    ;output information
    param.outputdir=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default
    param.outputxml=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/groups.xml
    param.debug=0

    [subflow1]
    fileName = /usr/local/annotation/AA1/Workflow/wu-blastp/856_default/groups.xml
    </div>
</div>


<div>
    <a href="javascript: hideShow('wu-blastp.pipeline.xml')"><img class='expander' id="iwu-blastp.pipeline.xml" src="../images/plus.png" alt='expand'></a>
    <span class="filename">wu-blastp/856_default/pipeline.xml</span>
    <div class="filecontents code" id="wu-blastp.pipeline.xml">
    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;commandSetRoot type="instance"&gt;
        &lt;commandSet type="serial" version="2.2"&gt;
            &lt;name&gt;wu-blastp workflow&lt;/name&gt;
            &lt;id&gt;155199052&lt;/id&gt;
            &lt;maxParallelCmds&gt;0&lt;/maxParallelCmds&gt;
            &lt;configMapId&gt;empty&lt;/configMapId&gt;
            &lt;state&gt;incomplete&lt;/state&gt;
            &lt;command&gt;
                &lt;name&gt;Create scratch space&lt;/name&gt;
                &lt;id&gt;155199053&lt;/id&gt;
                &lt;configMapId&gt;create_compute_scratch&lt;/configMapId&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
                &lt;type&gt;RunUnixCommand&lt;/type&gt;
                &lt;retryCount&gt;0&lt;/retryCount&gt;
                &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
                &lt;timeOut&gt;0&lt;/timeOut&gt;
                &lt;param&gt;
                    &lt;key&gt;command&lt;/key&gt;
                    &lt;value&gt;mkdir&lt;/value&gt;
                &lt;/param&gt;
                &lt;arg&gt;-p -m 777 /usr/local/scratch/aa1/wu-blastp/856_default&lt;/arg&gt;
            &lt;/command&gt;
            &lt;command&gt;
                &lt;name&gt;Create output repository&lt;/name&gt;
                &lt;id&gt;155199054&lt;/id&gt;
                &lt;configMapId&gt;create_compute_output&lt;/configMapId&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
                &lt;type&gt;RunUnixCommand&lt;/type&gt;
                &lt;retryCount&gt;0&lt;/retryCount&gt;
                &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
                &lt;timeOut&gt;0&lt;/timeOut&gt;
                &lt;param&gt;
                    &lt;key&gt;command&lt;/key&gt;
                    &lt;value&gt;mkdir&lt;/value&gt;
                &lt;/param&gt;
                &lt;arg&gt;-p -m 777 /usr/local/annotation/AA1/output_repository/wu-blastp/856_default&lt;/arg&gt;
            &lt;/command&gt;
            &lt;command&gt;
                &lt;name&gt;Create iterator list&lt;/name&gt;
                &lt;id&gt;155199055&lt;/id&gt;
                &lt;configMapId&gt;create_iterator_list_subflow1&lt;/configMapId&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
                &lt;type&gt;RunUnixCommand&lt;/type&gt;
                &lt;retryCount&gt;0&lt;/retryCount&gt;
                &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
                &lt;timeOut&gt;0&lt;/timeOut&gt;
                &lt;param&gt;
                    &lt;key&gt;directory&lt;/key&gt;
                    &lt;value&gt;&amp;apos;&amp;apos;&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;extension&lt;/key&gt;
                    &lt;value&gt;&amp;apos;fsa&amp;apos;&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;filelist&lt;/key&gt;
                    &lt;value&gt;&amp;apos;/usr/local/annotation/AA1/FASTA_repository/test.list&amp;apos;&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;command&lt;/key&gt;
                    &lt;value&gt;/usr/local/devel/ANNOTATION/ard/testing_manual/bin/generate_input_list&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;output&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/subflow1.list&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;file&lt;/key&gt;
                    &lt;value&gt;&amp;apos;&amp;apos;&lt;/value&gt;
                &lt;/param&gt;
            &lt;/command&gt;
            &lt;command&gt;
                &lt;name&gt;Create groups&lt;/name&gt;
                &lt;id&gt;155199056&lt;/id&gt;
                &lt;configMapId&gt;create_groups_subflow1&lt;/configMapId&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
                &lt;type&gt;RunUnixCommand&lt;/type&gt;
                &lt;retryCount&gt;0&lt;/retryCount&gt;
                &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
                &lt;timeOut&gt;0&lt;/timeOut&gt;
                &lt;param&gt;
                    &lt;key&gt;group_count&lt;/key&gt;
                    &lt;value&gt;150&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;command&lt;/key&gt;
                    &lt;value&gt;/usr/local/devel/ANNOTATION/ard/testing_manual/bin/generate_groups&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;file&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/subflow1.list&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;output_dir&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;prefix&lt;/key&gt;
                    &lt;value&gt;subflow1groups&lt;/value&gt;
                &lt;/param&gt;
            &lt;/command&gt;
            &lt;command&gt;
                &lt;name&gt;Create iterative subflow&lt;/name&gt;
                &lt;id&gt;155199057&lt;/id&gt;
                &lt;configMapId&gt;create_iterative_subflow1&lt;/configMapId&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
                &lt;type&gt;RunUnixCommand&lt;/type&gt;
                &lt;retryCount&gt;0&lt;/retryCount&gt;
                &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
                &lt;timeOut&gt;0&lt;/timeOut&gt;
                &lt;param&gt;
                    &lt;key&gt;inifile&lt;/key&gt;
                    &lt;value&gt;/usr/local/devel/ANNOTATION/ard/testing_manual/docs/groups-iterator.ini&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;debug&lt;/key&gt;
                    &lt;value&gt;0&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;conf&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/pipeline.config&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;command&lt;/key&gt;
                    &lt;value&gt;/usr/local/devel/ANNOTATION/ard/testing_manual/bin/generate_subflow&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;nodistrib&lt;/key&gt;
                    &lt;value&gt;0&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;outputxml&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/groups.xml&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;wfname&lt;/key&gt;
                    &lt;value&gt;wu-blastp&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;iteratorini&lt;/key&gt;
                    &lt;value&gt;/usr/local/devel/ANNOTATION/ard/testing_manual/docs/batch-iterator.ini&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;iteratortemplate&lt;/key&gt;
                    &lt;value&gt;/usr/local/devel/ANNOTATION/ard/testing_manual/docs/batch-paralleliterator_template.xml&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;outputdir&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;template&lt;/key&gt;
                    &lt;value&gt;/usr/local/devel/ANNOTATION/ard/testing_manual/docs/groups-iterator_template.xml&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;iteratorlist&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/subflow1groups.list&lt;/value&gt;
                &lt;/param&gt;
            &lt;/command&gt;
            &lt;commandSet type="parallel" version="2.2"&gt;
                &lt;name&gt;Iterated subflow&lt;/name&gt;
                &lt;id&gt;155199058&lt;/id&gt;
                &lt;maxParallelCmds&gt;0&lt;/maxParallelCmds&gt;
                &lt;configMapId&gt;subflow1&lt;/configMapId&gt;
                &lt;fileName&gt;/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/groups.xml&lt;/fileName&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
            &lt;/commandSet&gt;
            &lt;command&gt;
                &lt;name&gt;create bsml list&lt;/name&gt;
                &lt;id&gt;155199059&lt;/id&gt;
                &lt;configMapId&gt;create_bsml_list&lt;/configMapId&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
                &lt;type&gt;RunUnixCommand&lt;/type&gt;
                &lt;retryCount&gt;0&lt;/retryCount&gt;
                &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
                &lt;timeOut&gt;0&lt;/timeOut&gt;
                &lt;param&gt;
                    &lt;key&gt;command&lt;/key&gt;
                    &lt;value&gt;find&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;stdout&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/output_repository/wu-blastp/856_default/wu-blastp.bsml.list&lt;/value&gt;
                &lt;/param&gt;
                &lt;arg&gt;/usr/local/annotation/AA1/output_repository/wu-blastp/856_default -regex .*.wu-blastp.bsml&lt;/arg&gt;
            &lt;/command&gt;
            &lt;command&gt;
                &lt;name&gt;create raw list&lt;/name&gt;
                &lt;id&gt;155199060&lt;/id&gt;
                &lt;configMapId&gt;create_raw_list&lt;/configMapId&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
                &lt;type&gt;RunUnixCommand&lt;/type&gt;
                &lt;retryCount&gt;0&lt;/retryCount&gt;
                &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
                &lt;timeOut&gt;0&lt;/timeOut&gt;
                &lt;param&gt;
                    &lt;key&gt;command&lt;/key&gt;
                    &lt;value&gt;find&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;stdout&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/output_repository/wu-blastp/856_default/wu-blastp.raw.list&lt;/value&gt;
                &lt;/param&gt;
                &lt;arg&gt;/usr/local/annotation/AA1/output_repository/wu-blastp/856_default -regex .*.wu-blastp.raw&lt;/arg&gt;
            &lt;/command&gt;
            &lt;command&gt;
                &lt;name&gt;create btab list&lt;/name&gt;
                &lt;id&gt;155199061&lt;/id&gt;
                &lt;configMapId&gt;create_btab_list&lt;/configMapId&gt;
                &lt;state&gt;incomplete&lt;/state&gt;
                &lt;type&gt;RunUnixCommand&lt;/type&gt;
                &lt;retryCount&gt;0&lt;/retryCount&gt;
                &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
                &lt;timeOut&gt;0&lt;/timeOut&gt;
                &lt;param&gt;
                    &lt;key&gt;command&lt;/key&gt;
                    &lt;value&gt;find&lt;/value&gt;
                &lt;/param&gt;
                &lt;param&gt;
                    &lt;key&gt;stdout&lt;/key&gt;
                    &lt;value&gt;/usr/local/annotation/AA1/output_repository/wu-blastp/856_default/wu-blastp.btab.list&lt;/value&gt;
                &lt;/param&gt;
                &lt;arg&gt;/usr/local/annotation/AA1/output_repository/wu-blastp/856_default -regex .*.wu-blastp.btab&lt;/arg&gt;
            &lt;/command&gt;
        &lt;/commandSet&gt;
    &lt;/commandSetRoot&gt;

    </div>
</div>
<p>
    This file represents the work required to complete the wu-blastp component of the pipeline.  Note that all that has been
    defined within that subflow are any pre- and post- processing steps and that an iteration has to occur.  The iterator has
    not yet been created so we have no knowledge at this point of how many files are going to be included in the blast analysis.
    This does not occur until that workflow has started running.
</p>
<div class="changenote">
    The names of all these .ini/.config files need standardization.  Just runtime files so far are:
    <ul>
        <li>pipeline.config</li>
        <li>pipeline.xml.ini</li>
        <li>pipeline.ini</li>
        <li>component.conf.bld.ini</li>
    </ul>
</div>

<h2>running the pipeline - 2. file-based subflow</h2>
<p>
    The component pipeline.xml file just created is also the one referenced by the fileName 
    element in the last step of our original pipeline.xml.instance file.  Each of the commands
    and command sets within it will now be traversed.  The general structure of the average
    component has these three sections:
</p>
<dl>
    <dt>initial commands</dt>
    <dd>
        Here you might find initialization commands for a component run, such as handling of
        permissions, creation of output directories, and general data preparation.
    </dd>
    <dt>iteration</dt>
    <dd>
        The iteration section is where a specific set of commands is applied to each of your
        input files.  These steps are not defined within the pipeline.xml directly, but 
        instead subflows (groups) are made for them.  If you have 100,000 files to blast,
        this will happen here.
    </dd>
    <dt>cleanup/postprocessing commands</dt>
    <dd>
        Commands can be placed here to clean up after the iteration, such as temp file deletion,
        post-process permissions, or output list file creation.
    </dd>
</dl>
<p>
    In this workflow we have a few initial commands to make sure the output and temp directories
    are created.  One such command looks like this:
</p>
<p class='code'>
    &lt;command&gt;
        &lt;name&gt;Create scratch space&lt;/name&gt;
        &lt;id&gt;155199073&lt;/id&gt;
        &lt;configMapId&gt;create_compute_scratch&lt;/configMapId&gt;
        &lt;state&gt;incomplete&lt;/state&gt;
        &lt;type&gt;RunUnixCommand&lt;/type&gt;
        &lt;retryCount&gt;0&lt;/retryCount&gt;
        &lt;retryAttempts&gt;0&lt;/retryAttempts&gt;
        &lt;timeOut&gt;0&lt;/timeOut&gt;
        &lt;param&gt;
            &lt;key&gt;command&lt;/key&gt;
            &lt;value&gt;mkdir&lt;/value&gt;
        &lt;/param&gt;
        &lt;arg&gt;-p -m 777 /usr/local/scratch/aa1/wu-blastp/856_default&lt;/arg&gt;
    &lt;/command&gt;
</p>
<p>
    The component can have as many of these as necessary before the iteration.
</p>

<h2>component iterator</h2>
<p>
    The iteration section has four steps.  I'll first list each and their commands, then explain them.
</p>
<dl id='iterator_steps'>
    <dt>creation of the list</dt>
    <dd class='code'>
        generate_input_list 
            --directory='' 
            --extension='fsa' 
            --file='' 
            --filelist='/usr/local/annotation/AA1/FASTA_repository/test.list' 
            --output=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/subflow1.list
    </dd>
    <dt>creation of the groups</dt>
    <dd class='code'>
        generate_groups 
            --file=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/subflow1.list 
            --group_count=150 
            --output_dir=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default 
            --prefix=subflow1groups
    </dd>
    <dt>creation of the subflow</dt>
    <dd class='code'>
        generate_subflow 
            --conf=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/pipeline.config 
            --debug=0 
            --inifile=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/groups-iterator.ini 
            --iteratorini=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/batch-iterator.ini 
            --iteratorlist=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/subflow1groups.list 
            --iteratortemplate=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/batch-paralleliterator_template.xml 
            --nodistrib=0 
            --outputdir=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default 
            --outputxml=/usr/local/annotation/AA1/Workflow/wu-blastp/856_default/groups.xml 
            --template=/usr/local/devel/ANNOTATION/ard/testing_manual/docs/groups-iterator_template.xml 
            --wfname=wu-blastp
    </dd>
    <dt>execution of the subflow</dt>
    <dd class='code'>
        file-based subflow: groups.xml
    </dd>
</dl>

<h3>creation of the list</h3>
<p>
    Most components accepts three different types of input: a single file, a directory of files, 
    or a list of files.  Regardless of which method they enter, this step resolves their input
    to an iteration list file.  Different than an input list file, which just contains of list of
    file paths, this kind of list file defines a selection of variables for each input object.
    These can be referenced within the component code to select certain parts of the input element
    path or group.  Upon each iteration you will have access to the variables defined in this
    file.  If your file is /path/to/somefile.txt the variables will be: 
</p>
<ul>
    <li>$;ITER_FILE_PATH$; = /path/to/somefile.txt</li>
    <li>$;ITER_DIR$;       = /path/to</li>
    <li>$;ITER_FILE_NAME$; = somefile.txt</li>
    <li>$;ITER_FILE_BASE$; = somefile</li>
    <li>$;ITER_FILE_EXT$;  = txt</li>
</ul>
<p>
    Using these you would would be able to construct a string like:
</p>
<p class='code'>
    /usr/local/bin/blastp /usr/local/db/common/pfam_prots.db $;ITER_FILE_PATH$; -o /out/dir/$;ITER_FILE_BASE$;.out

</p>
<p>
    which would resolve to:
</p>
<p class='code'>
    /usr/local/bin/blastp /usr/local/db/common/pfam_prots.db /path/to/somefile.txt -o /out/dir/somefile.out

</p>
<p>
    Each line of this list file is the definition of one of those five variables.  The value of
    each is a comma-separated list with one entry per input file.
</p>

<h3>creation of the groups</h3>
<p>
    We can't define each of the steps to be performed within a single XML file because it simply
    wouldn't scale.  We are only able to perform 1,000,000 blast operations within the same
    pipeline because of an input set grouping strategy.  Each component contains a variable
    called GROUP_SIZE (needs to be renamed to GROUP_COUNT) which usually has a default value of
    150.  The generate_groups script reads the iteration list file created in the previous step
    and uses the GROUP_SIZE value to divide the input set into groups for processing.  If you
    have 100,000 input sequences and a GROUP_SIZE of 100 you'll get 100 analysis groups with
    1,000 sequences in each.
</p>

</body>

</html>











